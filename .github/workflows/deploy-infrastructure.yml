name: Deploy Infrastructure Updates

on:
    workflow_dispatch:
        inputs:
            confirm_cost_increase:
                description: "I understand this will increase costs to ~$660/month"
                required: true
                type: boolean
            confirm_downtime:
                description: "I understand there will be 10-15 minutes of downtime"
                required: true
                type: boolean

jobs:
    deploy-infrastructure:
        runs-on: ubuntu-latest
        if: ${{ inputs.confirm_cost_increase == true && inputs.confirm_downtime == true }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ap-southeast-1

            - name: Validate CloudFormation template
              run: |
                  echo "Validating CloudFormation template..."
                  aws cloudformation validate-template \
                    --template-body file://cloudformation-template.yaml \
                    --region ap-southeast-1

            - name: Create RDS backup snapshot
              run: |
                  SNAPSHOT_ID="debug-marathon-db-backup-$(date +%Y%m%d-%H%M%S)"
                  echo "Creating RDS snapshot: $SNAPSHOT_ID"

                  aws rds create-db-snapshot \
                    --db-instance-identifier debug-marathon-db \
                    --db-snapshot-identifier $SNAPSHOT_ID \
                    --region ap-southeast-1 || echo "Snapshot creation initiated or DB not found"

                  echo "SNAPSHOT_ID=$SNAPSHOT_ID" >> $GITHUB_ENV

            - name: Get current infrastructure state
              run: |
                  echo "=== Current Infrastructure State ==="

                  echo "RDS Configuration:"
                  aws rds describe-db-instances \
                    --db-instance-identifier debug-marathon-db \
                    --region ap-southeast-1 \
                    --query 'DBInstances[0].[DBInstanceClass,StorageType,MultiAZ,AllocatedStorage]' \
                    --output table || echo "RDS not found"

                  echo ""
                  echo "EC2 Instances:"
                  aws autoscaling describe-auto-scaling-groups \
                    --auto-scaling-group-names debug-marathon-asg \
                    --region ap-southeast-1 \
                    --query 'AutoScalingGroups[0].Instances[*].[InstanceId,InstanceType,AvailabilityZone]' \
                    --output table || echo "ASG not found"

            - name: Update CloudFormation stack
              id: stack_update
              run: |
                  echo "Updating CloudFormation stack..."
                  echo "This will take 20-30 minutes..."

                  UPDATE_ID=$(aws cloudformation update-stack \
                    --stack-name debug-marathon-stack \
                    --template-body file://cloudformation-template.yaml \
                    --parameters \
                      ParameterKey=DBUsername,UsePreviousValue=true \
                      ParameterKey=DBPassword,UsePreviousValue=true \
                      ParameterKey=KeyPairName,UsePreviousValue=true \
                    --capabilities CAPABILITY_IAM \
                    --region ap-southeast-1 \
                    --output text 2>&1)

                  if echo "$UPDATE_ID" | grep -q "No updates"; then
                    echo "STATUS=NO_UPDATES" >> $GITHUB_ENV
                    echo "No updates to perform - stack already up to date"
                  else
                    echo "STATUS=UPDATING" >> $GITHUB_ENV
                    echo "Stack update initiated: $UPDATE_ID"
                  fi

            - name: Wait for stack update to complete
              if: env.STATUS == 'UPDATING'
              run: |
                  echo "Monitoring stack update progress..."

                  for i in {1..60}; do
                    sleep 30
                    
                    STATUS=$(aws cloudformation describe-stacks \
                      --stack-name debug-marathon-stack \
                      --region ap-southeast-1 \
                      --query 'Stacks[0].StackStatus' \
                      --output text)
                    
                    ELAPSED=$((i / 2))
                    echo "[$ELAPSED min] Status: $STATUS"
                    
                    # Check for successful completion ONLY
                    if [[ "$STATUS" == "UPDATE_COMPLETE" ]]; then
                      echo "✅ Stack update completed successfully!"
                      exit 0
                    # Check for any failure or rollback states
                    elif [[ "$STATUS" == *"ROLLBACK"* ]] || [[ "$STATUS" == *"FAILED"* ]]; then
                      echo "❌ Stack update FAILED and rolled back!"
                      echo ""
                      echo "=== FAILURE REASON ==="
                      
                      echo "Recent failure events:"
                      aws cloudformation describe-stack-events \
                        --stack-name debug-marathon-stack \
                        --region ap-southeast-1 \
                        --query "StackEvents[?ResourceStatus=='UPDATE_FAILED' || ResourceStatus=='UPDATE_ROLLBACK_COMPLETE_CLEANUP_IN_PROGRESS']|[0:10].[Timestamp,LogicalResourceId,ResourceStatus,ResourceStatusReason]" \
                        --output table
                      
                      echo ""
                      echo "=== POSSIBLE CAUSES ==="
                      echo "1. RDS instance class not available (db.m5.large)"
                      echo "2. Storage cannot be reduced (GP2 20GB to GP3 100GB should work)"
                      echo "3. Parameter validation failed"
                      echo "4. Insufficient permissions"
                      echo "5. Resource limits/quotas exceeded"
                      echo ""
                      echo "Check the ResourceStatusReason above for the exact cause."
                      exit 1
                    fi
                  done

                  echo "⚠️ Timeout waiting for stack update (30 minutes)"
                  exit 1

            - name: Verify infrastructure upgrades
              if: env.STATUS == 'UPDATING'
              run: |
                  echo "=== Verifying Infrastructure Upgrades ==="

                  echo "RDS Configuration:"
                  RDS_CONFIG=$(aws rds describe-db-instances \
                    --db-instance-identifier debug-marathon-db \
                    --region ap-southeast-1 \
                    --query 'DBInstances[0].[DBInstanceClass,StorageType,MultiAZ,AllocatedStorage,Iops]' \
                    --output table)
                  echo "$RDS_CONFIG"

                  echo ""
                  echo "EC2 Instances:"
                  EC2_INSTANCES=$(aws autoscaling describe-auto-scaling-groups \
                    --auto-scaling-group-names debug-marathon-asg \
                    --region ap-southeast-1 \
                    --query 'AutoScalingGroups[0].Instances[*].[InstanceId,InstanceType,AvailabilityZone,HealthStatus]' \
                    --output table)
                  echo "$EC2_INSTANCES"

                  echo ""
                  echo "CloudWatch Alarms:"
                  aws cloudwatch describe-alarms \
                    --alarm-name-prefix debug-marathon \
                    --region ap-southeast-1 \
                    --query 'MetricAlarms[*].[AlarmName,StateValue]' \
                    --output table

            - name: Check target health
              if: env.STATUS == 'UPDATING'
              run: |
                  echo "Checking Load Balancer target health..."

                  TG_ARN=$(aws cloudformation describe-stack-resources \
                    --stack-name debug-marathon-stack \
                    --region ap-southeast-1 \
                    --query "StackResources[?LogicalResourceId=='TargetGroup'].PhysicalResourceId" \
                    --output text)

                  echo "Target Group: $TG_ARN"

                  aws elbv2 describe-target-health \
                    --target-group-arn $TG_ARN \
                    --region ap-southeast-1 \
                    --query 'TargetHealthDescriptions[*].[Target.Id,Target.AvailabilityZone,TargetHealth.State]' \
                    --output table

            - name: Get deployment outputs
              if: env.STATUS == 'UPDATING'
              run: |
                  echo "=== Deployment Outputs ==="

                  aws cloudformation describe-stacks \
                    --stack-name debug-marathon-stack \
                    --region ap-southeast-1 \
                    --query 'Stacks[0].Outputs' \
                    --output table

            - name: Deployment summary
              if: always()
              run: |
                  echo "========================================"
                  echo "INFRASTRUCTURE DEPLOYMENT SUMMARY"
                  echo "========================================"
                  echo "Status: ${{ env.STATUS }}"
                  echo "RDS Snapshot: ${{ env.SNAPSHOT_ID }}"
                  echo "Timestamp: $(date)"
                  echo ""
                  echo "Expected changes:"
                  echo "- RDS: db.t3.medium → db.m5.large"
                  echo "- Storage: GP2 → GP3 (3000 IOPS)"
                  echo "- Multi-AZ: Single → Multi-AZ"
                  echo "- EC2: t3.medium → m5.large"
                  echo "- AZs: 1 → 3 (ap-southeast-1a,b,c)"
                  echo "- Instances: Min 2→3, Max 6→9"
                  echo ""
                  echo "⚠️ Remember to monitor:"
                  echo "1. CloudWatch alarms for 24 hours"
                  echo "2. Performance Insights in RDS"
                  echo "3. Application logs"
                  echo "4. Cost in AWS Cost Explorer"
                  echo "========================================"

            - name: Send notification
              if: failure()
              run: |
                  echo "⚠️ Infrastructure deployment failed!"
                  echo "Check the logs above for details."
                  echo "RDS snapshot created: ${{ env.SNAPSHOT_ID }}"
                  echo "You may need to manually investigate in AWS Console."
