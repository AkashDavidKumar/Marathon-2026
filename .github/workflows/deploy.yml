name: Deploy to EC2 Servers

on:
  push:
    branches: [ "production-stable" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        mkdir -p deploy_package
        cp -r backend deploy_package/
        cp -r frontend deploy_package/
        cp nginx-optimized.conf deploy_package/
        cp supervisor-real.conf deploy_package/
        tar -czf app.tar.gz -C deploy_package .

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
        chmod 600 ~/.ssh/deploy_key.pem
        
    - name: Deploy to Master Server
      run: |
        SERVER_IP="${{ secrets.MASTER_IP }}"
        echo "Deploying to Master ($SERVER_IP)..."
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          
          # Smart Java Installation (Handles Ubuntu/Debian and Amazon Linux/RHEL)
          if [ -f /etc/debian_version ]; then
              echo "Detected Debian/Ubuntu system"
              sudo apt-get update -y
              sudo apt-get install -y openjdk-11-jdk
          elif [ -f /etc/redhat-release ] || [ -f /etc/system-release ]; then
              echo "Detected RHEL/Amazon Linux system"
              sudo yum update -y
              sudo yum install -y java-11-amazon-corretto-devel || sudo yum install -y java-1.11.0-openjdk-devel
          else
              echo "Unknown OS, attempting generic install..."
              sudo apt-get install -y openjdk-11-jdk || sudo yum install -y java-11-openjdk-devel || true
          fi
          
          # Verify Installation
          which javac || echo "WARNING: javac still not found in PATH"
          
          # Install dependencies
          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then
              sudo pip3 install -r requirements.txt --break-system-packages --ignore-installed
          fi
          
          sudo python3 setup_db.py || echo "DB Setup encountered an error/warning but continuing..."

          sudo mkdir -p /var/log/debug-marathon
          sudo chown ubuntu:ubuntu /var/log/debug-marathon
          sudo cp /opt/debug-marathon/supervisor-real.conf /etc/supervisor/conf.d/debug-marathon.conf
          sudo cp /opt/debug-marathon/nginx-optimized.conf /etc/nginx/conf.d/debug-marathon.conf
          
          sudo supervisorctl reread
          sudo supervisorctl update
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx
          
          rm /tmp/app.tar.gz
        '

    - name: Deploy to Worker 1
      run: |
        SERVER_IP="${{ secrets.WORKER1_IP }}"
        echo "Deploying to Worker 1 ($SERVER_IP)..."
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          
          if [ -f /etc/debian_version ]; then
              sudo apt-get update -y && sudo apt-get install -y openjdk-11-jdk
          elif [ -f /etc/redhat-release ] || [ -f /etc/system-release ]; then
              sudo yum install -y java-11-amazon-corretto-devel || sudo yum install -y java-1.11.0-openjdk-devel
          fi
          
          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then sudo pip3 install -r requirements.txt --break-system-packages --ignore-installed --quiet || true; fi
          
          sudo mkdir -p /var/log/debug-marathon
          sudo chown ubuntu:ubuntu /var/log/debug-marathon
          sudo cp /opt/debug-marathon/supervisor-real.conf /etc/supervisor/conf.d/debug-marathon.conf
          sudo cp /opt/debug-marathon/nginx-optimized.conf /etc/nginx/conf.d/debug-marathon.conf
          
          sudo supervisorctl reread
          sudo supervisorctl update
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx
          rm /tmp/app.tar.gz
        '

    - name: Deploy to Worker 2
      run: |
        SERVER_IP="${{ secrets.WORKER2_IP }}"
        echo "Deploying to Worker 2 ($SERVER_IP)..."
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          
          if [ -f /etc/debian_version ]; then
              sudo apt-get update -y && sudo apt-get install -y openjdk-11-jdk
          elif [ -f /etc/redhat-release ] || [ -f /etc/system-release ]; then
              sudo yum install -y java-11-amazon-corretto-devel || sudo yum install -y java-1.11.0-openjdk-devel
          fi

          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then sudo pip3 install -r requirements.txt --break-system-packages --ignore-installed --quiet || true; fi
          
          sudo mkdir -p /var/log/debug-marathon
          sudo chown ubuntu:ubuntu /var/log/debug-marathon
          sudo cp /opt/debug-marathon/supervisor-real.conf /etc/supervisor/conf.d/debug-marathon.conf
          sudo cp /opt/debug-marathon/nginx-optimized.conf /etc/nginx/conf.d/debug-marathon.conf
          
          sudo supervisorctl reread
          sudo supervisorctl update
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx
          rm /tmp/app.tar.gz
        '

    - name: Deploy to Worker 3
      run: |
        SERVER_IP="${{ secrets.WORKER3_IP }}"
        echo "Deploying to Worker 3 ($SERVER_IP)..."
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          
          if [ -f /etc/debian_version ]; then
              sudo apt-get update -y && sudo apt-get install -y openjdk-11-jdk
          elif [ -f /etc/redhat-release ] || [ -f /etc/system-release ]; then
              sudo yum install -y java-11-amazon-corretto-devel || sudo yum install -y java-1.11.0-openjdk-devel
          fi

          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then sudo pip3 install -r requirements.txt --break-system-packages --ignore-installed --quiet || true; fi
          
          sudo mkdir -p /var/log/debug-marathon
          sudo chown ubuntu:ubuntu /var/log/debug-marathon
          sudo cp /opt/debug-marathon/supervisor-real.conf /etc/supervisor/conf.d/debug-marathon.conf
          sudo cp /opt/debug-marathon/nginx-optimized.conf /etc/nginx/conf.d/debug-marathon.conf
          
          sudo supervisorctl reread
          sudo supervisorctl update
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx
          rm /tmp/app.tar.gz
        '

    - name: Verification
      run: |
        echo "Deployment completed to all servers."
