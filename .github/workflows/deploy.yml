name: Deploy to EC2 Servers

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        mkdir -p deploy_package
        cp -r backend deploy_package/
        cp -r frontend deploy_package/
        # Create tarball preserving permissions
        tar -czf app.tar.gz -C deploy_package .
        echo "Package created: $(du -h app.tar.gz | cut -f1)"

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
        chmod 600 ~/.ssh/deploy_key.pem
        
    - name: Deploy to Master Server
      run: |
        SERVER_IP="${{ secrets.MASTER_IP }}"
        echo "Deploying to Master ($SERVER_IP)..."
        
        # Upload
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        
        # Execute remote commands
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          
          # Install dependencies
          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then
              sudo pip3 install -r requirements.txt --break-system-packages --quiet || true
          fi
          
          # Restart services
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx || true
          
          rm /tmp/app.tar.gz
          echo "Deployment to Master completed."
        '

    - name: Deploy to Worker 1
      run: |
        SERVER_IP="${{ secrets.WORKER1_IP }}"
        echo "Deploying to Worker 1 ($SERVER_IP)..."
        
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then sudo pip3 install -r requirements.txt --break-system-packages --quiet || true; fi
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx || true
          rm /tmp/app.tar.gz
          echo "Deployment to Worker 1 completed."
        '

    - name: Deploy to Worker 2
      run: |
        SERVER_IP="${{ secrets.WORKER2_IP }}"
        echo "Deploying to Worker 2 ($SERVER_IP)..."
        
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then sudo pip3 install -r requirements.txt --break-system-packages --quiet || true; fi
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx || true
          rm /tmp/app.tar.gz
          echo "Deployment to Worker 2 completed."
        '

    - name: Deploy to Worker 3
      run: |
        SERVER_IP="${{ secrets.WORKER3_IP }}"
        echo "Deploying to Worker 3 ($SERVER_IP)..."
        
        scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no app.tar.gz ubuntu@${SERVER_IP}:/tmp/
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
          set -e
          sudo mkdir -p /opt/debug-marathon
          sudo tar -xzf /tmp/app.tar.gz -C /opt/debug-marathon
          cd /opt/debug-marathon/backend
          if [ -f requirements.txt ]; then sudo pip3 install -r requirements.txt --break-system-packages --quiet || true; fi
          sudo supervisorctl restart debug-marathon || true
          sudo systemctl restart nginx || true
          rm /tmp/app.tar.gz
          echo "Deployment to Worker 3 completed."
        '

    - name: Verification
      run: |
        echo "Deployment completed to all servers."
